class Signal{constructor(t){this._value=t,this._subscribers=new Set}get(){return this._value}set(e){this._value!==e&&(this._value=e,this._subscribers.forEach(t=>t(e)))}subscribe(t){return this._subscribers.add(t),()=>this._subscribers.delete(t)}map(e){let s=new Signal(e(this._value)),t=this.subscribe(t=>s.set(e(t)));return s._cleanup=t,s}dispose(){this._cleanup&&(this._cleanup(),this._cleanup=null),this._subscribers.clear()}static combine(...e){let s=new Signal(e.map(t=>t.get()));return e.forEach(t=>{t.subscribe(()=>{s.set(e.map(t=>t.get()))})}),s}debounce(e){let s=new Signal(this._value),i;return this.subscribe(t=>{clearTimeout(i),i=setTimeout(()=>s.set(t),e)}),s}}function effect(e,...t){e(),t.forEach(t=>t.subscribe(()=>e()))}class MinHeap{constructor(t){this.heap=[],this.compare=t}size(){return this.heap.length}peek(){return this.heap[0]}push(t){this.heap.push(t),this._bubbleUp(this.heap.length-1)}pop(){var t;if(0!==this.heap.length)return 1===this.heap.length?this.heap.pop():(t=this.heap[0],this.heap[0]=this.heap.pop(),this._bubbleDown(0),t)}_bubbleUp(t){for(;0<t;){var e=Math.floor((t-1)/2);if(0<=this.compare(this.heap[t],this.heap[e]))break;[this.heap[t],this.heap[e]]=[this.heap[e],this.heap[t]],t=e}}_bubbleDown(i){for(var r=this.heap.length;;){let t=2*i+1,e=2*i+2,s=i;if(t<r&&this.compare(this.heap[t],this.heap[s])<0&&(s=t),(s=e<r&&this.compare(this.heap[e],this.heap[s])<0?e:s)===i)break;[this.heap[i],this.heap[s]]=[this.heap[s],this.heap[i]],i=s}}}class CycleEngine{constructor(t={}){this.cyclesPerFrame=t.cyclesPerFrame||1e3,this.currentCycle=0,this.running=!1,this.frameId=null,this.callbacks=new Map,this.timerHeap=new MinHeap((t,e)=>t.triggerCycle-e.triggerCycle),this.perfCounters={cyclesExecuted:0,framesRendered:0,lastSecond:performance.now()},this.cyclesPerSecond=0,this.framesPerSecond=0}after(t,e){t={triggerCycle:this.currentCycle+t,callback:e,id:Symbol("timer")};return this.timerHeap.push(t),t.id}tick(t){for(t(this.currentCycle),this.currentCycle++,this.perfCounters.cyclesExecuted++;0<this.timerHeap.size()&&this.timerHeap.peek().triggerCycle<=this.currentCycle;)this.timerHeap.pop().callback()}run(t,e){for(var s=this.currentCycle+t;this.currentCycle<s;){var i=4<=s-this.currentCycle&&0===this.timerHeap.size()?4:1;for(let t=0;t<i;t++)e(this.currentCycle),this.currentCycle++,this.perfCounters.cyclesExecuted++;for(;0<this.timerHeap.size()&&this.timerHeap.peek().triggerCycle<=this.currentCycle;)this.timerHeap.pop().callback()}}start(r){if(!this.running){this.running=!0;let e=performance.now(),s=1e3/60,i=t=>{this.running&&(t-e<s||(e=t,this.run(this.cyclesPerFrame,r),this.perfCounters.framesRendered++,1e3<=t-this.perfCounters.lastSecond&&(this.cyclesPerSecond=this.perfCounters.cyclesExecuted,this.framesPerSecond=this.perfCounters.framesRendered,this.perfCounters.cyclesExecuted=0,this.perfCounters.framesRendered=0,this.perfCounters.lastSecond=t)),this.frameId=requestAnimationFrame(i))};this.frameId=requestAnimationFrame(i)}}stop(){this.running=!1,this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=null)}reset(){this.stop(),this.currentCycle=0,this.timerHeap=new MinHeap((t,e)=>t.triggerCycle-e.triggerCycle)}getCycles(){return this.currentCycle}getPerformance(){return{cyclesPerSecond:this.cyclesPerSecond,framesPerSecond:this.framesPerSecond,totalCycles:this.currentCycle}}}class State{constructor(t={}){this.current={...t},this.history=[{...t}],this.maxHistory=100,this.subscribers=[]}get(t){return this.current[t]}update(t){let e={...this.current,...t};return this.current=e,this.history.push({...e}),this.history.length>this.maxHistory&&this.history.shift(),this.subscribers.forEach(t=>t(e)),e}batch(t){var e={};return t(new Proxy(e,{set(t,e,s){return t[e]=s,!0}})),this.update(e)}rewind(t=1){this.history.length>t&&(this.history.splice(-t),this.current={...this.history[this.history.length-1]},this.subscribers.forEach(t=>t(this.current)))}subscribe(e){return this.subscribers.push(e),()=>{this.subscribers=this.subscribers.filter(t=>t!==e)}}reset(){0<this.history.length&&(this.current={...this.history[0]},this.history=[{...this.history[0]}],this.subscribers.forEach(t=>t(this.current)))}}let Bits={get(t,e){return t>>e&1},set(t,e,s=1){return s?t|1<<e:t&~(1<<e)},toggle(t,e){return t^1<<e},slice(t,e,s){return t>>e&(1<<s)-1},patch(t,e,s,i){s=(1<<s)-1<<e;return t&~s|i<<e&s},popcount(t){let e=0;for(;t;)e+=1&t,t>>=1;return e},rotl(t,e,s=8){var i=(1<<s)-1;return((t&=i)<<e|t>>s-e)&i},rotr(t,e,s=8){var i=(1<<s)-1;return((t&=i)>>e|t<<s-e)&i},signExtend(t,e){return t>>e-1?t|-1<<e:t},toBinary(t,e=8){return t.toString(2).padStart(e,"0")},toHex(t,e=2){return"0x"+t.toString(16).toUpperCase().padStart(e,"0")}};function match(t,e){for(var[s,i]of Object.entries(e)){if("_"===s)return i(t);if("function"==typeof s){if(s(t))return i(t)}else if(t===s)return i(t)}throw new Error("No pattern matched for value: "+t)}let range=(e,s)=>t=>e<=t&&t<=s,oneOf=(...e)=>t=>e.includes(t),bits=(e,s)=>t=>(t&e)===s;class Entity{constructor(t=Symbol("entity"),e=null){this.id=t,this.components=new Map,this.tags=new Set,this.world=e}add(t,e){return this.components.set(t,e),this.world&&this.world._invalidateCache(),this}get(t){return this.components.get(t)}has(t){return this.components.has(t)}remove(t){return this.components.delete(t),this.world&&this.world._invalidateCache(),this}tag(...t){return t.forEach(t=>this.tags.add(t)),this}hasTag(t){return this.tags.has(t)}}class World{constructor(){this.entities=new Map,this.systems=[],this.queryCache=new Map,this.cacheVersion=0}spawn(t){return(t.world=this).entities.set(t.id,t),this._invalidateCache(),t}destroy(t){var e=this.entities.get(t);e&&(e.world=null),this.entities.delete(t),this._invalidateCache()}_invalidateCache(){this.cacheVersion++}query(...e){var t=e.join(","),s=this.queryCache.get(t);if(s&&s.version===this.cacheVersion)return s.result;var i,r=[];for(i of this.entities.values()){let t=!0;for(var h of e)if(!i.has(h)){t=!1;break}t&&r.push(i)}return this.queryCache.set(t,{result:r,version:this.cacheVersion}),r}addSystem(t){this.systems.push(t)}update(e){this.systems.forEach(t=>t(this,e))}}class Schema{static string(s={}){return(t,e="")=>{if("string"!=typeof t)throw new Error(e+": Expected string, got "+typeof t);if(s.min&&t.length<s.min)throw new Error(e+`: String too short (min: ${s.min})`);if(s.max&&t.length>s.max)throw new Error(e+`: String too long (max: ${s.max})`);if(s.pattern&&!s.pattern.test(t))throw new Error(e+": String doesn't match pattern");return t}}static number(s={}){return(t,e="")=>{if("number"!=typeof t||isNaN(t))throw new Error(e+": Expected number, got "+typeof t);if(void 0!==s.min&&t<s.min)throw new Error(e+`: Number too small (min: ${s.min})`);if(void 0!==s.max&&s.max<t)throw new Error(e+`: Number too large (max: ${s.max})`);if(s.integer&&!Number.isInteger(t))throw new Error(e+": Expected integer");return t}}static object(h){return(t,e="")=>{if("object"!=typeof t||null===t)throw new Error(e+": Expected object, got "+typeof t);var s,i,r={};for([s,i]of Object.entries(h))r[s]=i(t[s],e?e+"."+s:s);return r}}static array(i){return(t,s="")=>{if(Array.isArray(t))return t.map((t,e)=>i(t,s+`[${e}]`));throw new Error(s+": Expected array, got "+typeof t)}}static optional(s){return(t,e="")=>null==t?t:s(t,e)}static oneOf(...i){return(t,e="")=>{for(var s of i)try{return s(t,e)}catch{}throw new Error(e+": Value didn't match any schema")}}static validate(t,e){try{return{valid:!0,data:t(e)}}catch(t){return{valid:!1,error:t.message}}}}class Memory{constructor(t,e={}){this.size=t>>>0,this.data=new Uint8Array(t),this.watchers=new Map,this.readOnly=new Set(e.readOnly||[]),this.mirrors=Array.isArray(e.mirrors)?e.mirrors.slice():[],this.wordWidth=e.wordWidth||8,this.perfCounters={reads:0,writes:0,lastSecond:performance.now()},this.opsPerSecond=0}static create4bit(t,e={}){return new Memory(t,{...e,wordWidth:4})}static create8bit(t,e={}){return new Memory(t,{...e,wordWidth:8})}static create16bit(t,e={}){return new Memory(t,{...e,wordWidth:16})}mapMMIO(t,e,s){t=Number(t)>>>0,e=Number(e)>>>0;if(e<t)throw new Error("mapMMIO: start must be <= end");this.mirrors.push({start:t,end:e,target:s})}read(t){var e;return this._checkBounds(t),this.perfCounters.reads++,0===this.mirrors.length&&0===this.watchers.size?this.data[t]:(t=this._resolveAddress(t),e=this.data[t],this._notifyWatchers(t,"read",e),e)}write(t,e){if(this._checkBounds(t),this.perfCounters.writes++,0===this.mirrors.length&&0===this.watchers.size&&0===this.readOnly.size)this.data[t]=255&e;else{t=this._resolveAddress(t);if(this.readOnly.has(t))throw new Error("Attempt to write to read-only address 0x"+t.toString(16));var s=this.data[t];this.data[t]=255&e,this._notifyWatchers(t,"write",255&e,s)}}read16(t){return(this.read(t)|this.read(t+1)<<8)>>>0}write16(t,e){this.write(t,255&e),this.write(t+1,e>>8&255)}watch(t,e){t=Number(t)>>>0;this.watchers.has(t)||this.watchers.set(t,[]),this.watchers.get(t).push(e)}load(t,e){if(e&&0!==e.length){var s=Number(t)>>>0,i=e.length>>>0;if(this._checkBounds(s),this._checkBounds(s+i-1),0===this.mirrors.length&&0===this.watchers.size&&0===this.readOnly.size)this.data.set(e,s),this.perfCounters.writes+=i;else for(let t=0;t<i;t++)this.write(s+t,e[t])}}fill(t,e,s){var i=Number(t)>>>0,r=Number(e)>>>0;if(0!=r){this._checkBounds(i),this._checkBounds(i+r-1);var h=255&s;if(0===this.mirrors.length&&0===this.watchers.size&&0===this.readOnly.size)this.data.fill(h,i,i+r),this.perfCounters.writes+=r;else for(let t=0;t<r;t++)this.write(i+t,h)}}slice(t,e){return Array.from(this.data.slice(t,e))}copy(t,e,s){var t=Number(t)>>>0,e=Number(e)>>>0,s=Number(s)>>>0;0!=s&&(this._checkBounds(t),this._checkBounds(t+s-1),this._checkBounds(e),this._checkBounds(e+s-1),t=this.data.slice(t,t+s),this.load(e,t))}_resolveAddress(t){var e=Number(t)>>>0;for(let t=0;t<this.mirrors.length;t++){var s=this.mirrors[t];if(e>=s.start&&e<=s.end)return"number"==typeof s.target?s.target+(e-s.start)>>>0:e}return e}_checkBounds(t){t=Number(t)>>>0;if(t<0||t>=this.size)throw new Error("Memory access out of bounds: 0x"+t.toString(16))}_notifyWatchers(e,s,i,r){var h=this.watchers.get(e);if(h&&h.length)for(let t=0;t<h.length;t++)try{h[t]({address:e,type:s,value:i,oldValue:r})}catch(t){}}getPerformance(){var t=performance.now();return 1e3<=t-this.perfCounters.lastSecond&&(this.opsPerSecond=this.perfCounters.reads+this.perfCounters.writes,this.perfCounters.reads=0,this.perfCounters.writes=0,this.perfCounters.lastSecond=t),this.opsPerSecond}}let CC_MAGIC=1128481107,CC_VERSION=1,OP={LOAD:0,STORE:1,LOAD_IMM:2,LOAD_LOCAL:3,STORE_LOCAL:4,LOAD_STR:5,LOAD_IMM_0:6,LOAD_IMM_1:7,LOAD_IMM_M1:8,INC_LOCAL:9,DEC_LOCAL:10,ADD_IMM:11,SUB_IMM:12,MUL_IMM:13,CMP_ZERO:14,STORE_PUSH:15,ADD:16,SUB:17,MUL:18,DIV:19,MOD:20,INC:21,DEC:22,NEG:23,EQ:24,NE:25,LT:26,GT:27,LE:28,GE:29,AND:32,OR:33,XOR:34,SHL:35,SHR:36,NOT:37,LOAD8:38,STORE8:39,LOAD16:40,STORE16:41,JMP:48,JZ:49,JNZ:50,CALL:51,RET:52,LOOP:53,ENDLOOP:54,BREAK:55,CONTINUE:56,PUSH:64,POP:65,DUP:66,SWAP:67,TICK:80,WAIT:81,PRINT:96,INPUT:97,NOP:240,HALT:255};class CCCompiler{constructor(){this.bytecode=[],this.labels=new Map,this.constants=new Map,this.functions=new Map,this.localVars=new Map,this.loopStack=[],this.stringTable=[],this.optimizationLevel=2,this.useStrict=!1,this.useOptimization=2,this.useNative=!1}compile(t){this.bytecode=[],this.labels.clear(),this.functions.clear(),this.localVars.clear(),this.loopStack=[],this.stringTable=[],this._parseDirectives(t);var t=this._tokenize(t),t=this._parse(t),t=(this._generate(t),0<this.optimizationLevel&&this._optimize(),this.bytecode),e=this._buildHeader();return this.bytecode=Array.from(e).concat(t),new Uint8Array(this.bytecode)}_parseDirectives(t){var e;for(e of t.split("\n")){var s,i=e.trim();";use strict"===i?this.useStrict=!0:i.startsWith(";use optimization")?(s=parseInt(i.split(" ")[2]),isNaN(s)||(this.optimizationLevel=Math.max(0,Math.min(2,s)),this.useOptimization=this.optimizationLevel)):";use native"===i&&(this.useNative=!0)}}_buildHeader(){let e=[];var t,s,i,r,h=t=>e.push(255&t),a=t=>{e.push(255&t,t>>8&255,t>>16&255,t>>24&255)};for(t of this.functions.keys())this.stringTable.includes(t)||this.stringTable.push(t);a(CC_MAGIC),h(CC_VERSION),h((this.useStrict?1:0)|(this.useNative?2:0)|(3&this.useOptimization)<<2),h(this.stringTable.length);for(s of this.stringTable){h(s.length);for(let t=0;t<s.length;t++)h(s.charCodeAt(t))}h(this.functions.size);for([i,r]of this.functions){var n=this.stringTable.indexOf(i);a(-1===n?4294967295:n),a(r)}return e}_emit32(t){this.bytecode.push(255&t,t>>8&255,t>>16&255,t>>24&255)}_tokenize(t){for(var e,s=[],i=/\s*(;use [^\n]*|=>|==|!=|<=|>=|<<|>>|\+\+|--|[{}()\[\];,+\-*/%&|^<>!=]|\d+|[a-zA-Z_]\w*|"[^"]*"|#[^\n]*)\s*/g;null!==(e=i.exec(t));)!e[1]||e[1].startsWith("#")||e[1].startsWith(";use")||s.push(e[1]);return s}_parse(r){let t={type:"program",body:[]},h=0,a=()=>{for(var t=[];h<r.length&&"}"!==r[h]&&"end"!==r[h];){var e=s();e&&t.push(e)}return t},n=()=>{let t=i();for(;h<r.length;){var e=r[h];if(["+","-","*","/","%","==","!=","<",">","<=",">=","&","|","^","<<",">>"].includes(e)){h++;var s=i();t={type:"binary",op:e,left:t,right:s}}else{if("++"!==e&&"--"!==e)break;h++,t={type:"unary",op:e,operand:t}}}return t},i=()=>{var t=r[h++],e=parseInt(t);if(!isNaN(e))return{type:"literal",value:e};if(t&&t.startsWith('"'))return{type:"string",value:t.slice(1,-1)};if("("!==r[h])return{type:"variable",name:t};h++;for(var s=[];")"!==r[h];)s.push(n()),","===r[h]&&h++;return h++,{type:"call",name:t,args:s}},s=()=>{if(h>=r.length)return null;var e=r[h];if("let"===e||"const"===e)return i="const"===e,h++,t=r[h++],h++,{type:"declaration",name:t,value:n(),isConst:i};if("fn"===e){h++;for(var t=r[h++],s=(h++,[]);")"!==r[h];)s.push(r[h++]),","===r[h]&&h++;h++,h++;var i=a();return h++,{type:"function",name:t,params:s,body:i}}if("loop"===e)return h++,t=n(),h++,i=a(),h++,{type:"loop",count:t,body:i};if("while"===e)return h++,t=n(),h++,i=a(),h++,{type:"while",condition:t,body:i};if("if"!==e)return"return"===e?(h++,{type:"return",value:n()}):"break"===e?(h++,{type:"break"}):"continue"===e?(h++,{type:"continue"}):"print"===e?(h++,{type:"print",value:n()}):"tick"===e?(h++,{type:"tick"}):"wait"===e?(h++,{type:"wait",cycles:n()}):(t=n(),"="===r[h]?(h++,{type:"assignment",target:t,value:n()}):{type:"expression",expr:t});{h++;i=n(),e=(h++,a());h++;let t=null;return"else"===r[h]&&(h++,h++,t=a(),h++),{type:"if",condition:i,consequent:e,alternate:t}}};for(;h<r.length;){var e=s();e&&t.body.push(e)}return t}_generate(t){for(var e of t.body)this._generateNode(e);this._emit(OP.HALT)}_generateNode(t){if(t)switch(t.type){case"declaration":2<=this.optimizationLevel&&t.value&&"literal"===t.value.type?this._emit(OP.LOAD_IMM,t.value.value):this._generateExpression(t.value),this._emit(OP.STORE_LOCAL,this._getLocalVar(t.name));break;case"assignment":this._generateExpression(t.value),"variable"===t.target.type&&this._emit(OP.STORE_LOCAL,this._getLocalVar(t.target.name));break;case"function":var e,s=this.bytecode.length;this.functions.set(t.name,s);for(e of t.body)this._generateNode(e);this._emit(OP.RET);break;case"loop":var i,s=this.bytecode.length;this.loopStack.push({start:s,breaks:[]}),this._generateExpression(t.count),this._emit(OP.LOOP);for(i of t.body)this._generateNode(i);this._emit(OP.ENDLOOP),this._emit(OP.JMP,s),this.loopStack.pop().breaks.forEach(t=>{this.bytecode[t]=this.bytecode.length});break;case"while":var r,s=this.bytecode.length,h=(this.loopStack.push({start:s,breaks:[]}),this._generateExpression(t.condition),this.bytecode.length);this._emit(OP.JZ,0);for(r of t.body)this._generateNode(r);this._emit(OP.JMP,s),this.bytecode[h+1]=255&this.bytecode.length,this.loopStack.pop().breaks.forEach(t=>{this.bytecode[t]=this.bytecode.length});break;case"if":this._generateExpression(t.condition);var a,s=this.bytecode.length;this._emit(OP.JZ,0);for(a of t.consequent)this._generateNode(a);if(t.alternate){var n,h=this.bytecode.length;this._emit(OP.JMP,0),this.bytecode[s+1]=255&this.bytecode.length;for(n of t.alternate)this._generateNode(n);this.bytecode[h+1]=255&this.bytecode.length}else this.bytecode[s+1]=255&this.bytecode.length;break;case"return":t.value&&this._generateExpression(t.value),this._emit(OP.RET);break;case"break":0<this.loopStack.length&&(h=this.bytecode.length,this._emit(OP.BREAK),this._emit(OP.JMP,0),this.loopStack[this.loopStack.length-1].breaks.push(h+2));break;case"continue":0<this.loopStack.length&&(this._emit(OP.CONTINUE),this._emit(OP.JMP,this.loopStack[this.loopStack.length-1].start));break;case"print":this._generateExpression(t.value),this._emit(OP.PRINT);break;case"tick":this._emit(OP.TICK);break;case"wait":this._generateExpression(t.cycles),this._emit(OP.WAIT);break;case"expression":this._generateExpression(t.expr)}}_generateExpression(i){if(i)switch(i.type){case"literal":this._emitLoadImm(i.value);break;case"string":var t=this._addString(i.value);this._emit(OP.LOAD_STR,t);break;case"variable":this._emit(OP.LOAD_LOCAL,this._getLocalVar(i.name));break;case"binary":if(2<=this.optimizationLevel&&"literal"===i.left.type&&"literal"===i.right.type){let t=i.left.value,e=i.right.value,s=0;switch(i.op){case"+":s=t+e;break;case"-":s=t-e;break;case"*":s=t*e;break;case"/":s=0!==e?Math.floor(t/e):0;break;case"%":s=0!==e?t%e:0;break;case"==":s=t===e?1:0;break;case"!=":s=t!==e?1:0;break;case"<":s=t<e?1:0;break;case">":s=e<t?1:0;break;case"<=":s=t<=e?1:0;break;case">=":s=e<=t?1:0;break;case"&":s=t&e;break;case"|":s=t|e;break;case"^":s=t^e;break;case"<<":s=t<<e;break;case">>":s=t>>e}this._emit(OP.LOAD_IMM,s)}else{if(2<=this.optimizationLevel&&"variable"===i.left.type&&"literal"===i.right.type){if(1===i.right.value){if("+"===i.op)return void this._emit(OP.INC_LOCAL,this._getLocalVar(i.left.name));if("-"===i.op)return void this._emit(OP.DEC_LOCAL,this._getLocalVar(i.left.name))}if(-128<=i.right.value&&i.right.value<=127){if(this._emit(OP.LOAD_LOCAL,this._getLocalVar(i.left.name)),"+"===i.op)return void this._emit(OP.ADD_IMM,i.right.value);if("-"===i.op)return void this._emit(OP.SUB_IMM,i.right.value);if("*"===i.op&&(2===i.right.value||4===i.right.value||8===i.right.value))return t=Math.log2(i.right.value),this._emit(OP.PUSH),this._emitLoadImm(t),void this._emit(OP.SHL)}}this._generateExpression(i.left),this._emit(OP.PUSH),this._generateExpression(i.right);t={"+":OP.ADD,"-":OP.SUB,"*":OP.MUL,"/":OP.DIV,"%":OP.MOD,"==":OP.EQ,"!=":OP.NE,"<":OP.LT,">":OP.GT,"<=":OP.LE,">=":OP.GE,"&":OP.AND,"|":OP.OR,"^":OP.XOR,"<<":OP.SHL,">>":OP.SHR};this._emit(t[i.op]||OP.NOP)}break;case"unary":this._generateExpression(i.operand),"++"===i.op&&this._emit(OP.INC),"--"===i.op&&this._emit(OP.DEC);break;case"call":for(var e of i.args)this._generateExpression(e),this._emit(OP.PUSH);t=this.functions.get(i.name);void 0!==t&&this._emit(OP.CALL,t)}}_addString(t){let e=this.stringTable.indexOf(t);return-1===e&&(e=this.stringTable.length,this.stringTable.push(t)),e}_getLocalVar(t){return this.localVars.has(t)||this.localVars.set(t,this.localVars.size),this.localVars.get(t)}_emit(t,e=null){this.bytecode.push(t),null!==e&&"number"==typeof e&&this.bytecode.push(255&e,e>>8&255,e>>16&255,e>>24&255)}_emitLoadImm(t){0===t?this._emit(OP.LOAD_IMM_0):1===t?this._emit(OP.LOAD_IMM_1):-1===t?this._emit(OP.LOAD_IMM_M1):this._emit(OP.LOAD_IMM,t)}_getConstant(t){return this.constants.has(t)||this.constants.set(t,this.constants.size),this.constants.get(t)}_optimize(){1<=this.optimizationLevel&&this._optimizeBasic(),2<=this.optimizationLevel&&this._optimizeAggressive()}_optimizeBasic(){let e=[],s=!1;for(let t=0;t<this.bytecode.length;t++){var i=this.bytecode[t];i===OP.NOP?s||(e.push(i),s=!0):(e.push(i),s=!1)}this.bytecode=e}_optimizeAggressive(){var e=[];for(let t=0;t<this.bytecode.length;t++){var s=this.bytecode[t];if(s===OP.HALT){e.push(s);break}if(s===OP.PUSH&&t+1<this.bytecode.length&&this.bytecode[t+1]===OP.POP)t++;else{if(s===OP.LOAD_IMM&&t+5<this.bytecode.length){var i=this.bytecode[t+1]|this.bytecode[t+2]<<8|this.bytecode[t+3]<<16|this.bytecode[t+4]<<24;if(0==i){if(this.bytecode[t+5]===OP.ADD||this.bytecode[t+5]===OP.SUB){t+=5;continue}if(this.bytecode[t+5]===OP.MUL){e.push(OP.LOAD_IMM_0),t+=5;continue}}if(1==i&&this.bytecode[t+5]===OP.MUL){t+=5;continue}}s===OP.LOAD_LOCAL&&t+9<this.bytecode.length&&this.bytecode[t+5]===OP.STORE_LOCAL&&(this.bytecode[t+1]|this.bytecode[t+2]<<8|this.bytecode[t+3]<<16|this.bytecode[t+4]<<24)==(this.bytecode[t+6]|this.bytecode[t+7]<<8|this.bytecode[t+8]<<16|this.bytecode[t+9]<<24)?t+=9:s===OP.INC&&t+1<this.bytecode.length&&this.bytecode[t+1]===OP.INC?(e.push(OP.ADD_IMM),e.push(2,0,0,0),t++):e.push(s)}}this.bytecode=e}disassemble(r){let h=[],a=0,n=[];if(6<=r.length){var t=r[0]|r[1]<<8|r[2]<<16|r[3]<<24;if(t===CC_MAGIC){h.push(`Header: CC_MAGIC (0x${t.toString(16)})`),h.push("Version: "+r[4]);var t=r[5],e=(h.push(`Flags: strict=${!!(1&t)}, native=${!!(2&t)}, opt=`+(t>>2&3)),a=6,r[a++]);h.push("Strings: "+e);for(let t=0;t<e;t++){let e=r[a++],s="";for(let t=0;t<e;t++)s+=String.fromCharCode(r[a++]);n.push(s),h.push(`  [${t}]: "${s}"`)}if(a<r.length){var s=r[a++];h.push("Exports: "+s);for(let t=0;t<s&&a+7<r.length;t++){var i=r[a]|r[a+1]<<8|r[a+2]<<16|r[a+3]<<24,c=r[a+=4]|r[a+1]<<8|r[a+2]<<16|r[a+3]<<24;a+=4,h.push(`  ${0<=i&&i<n.length?n[i]:"#"+i} -> 0x`+c.toString(16).padStart(4,"0"))}}h.push("---")}}for(;a<r.length;){let e=r[a],t,s=Object.keys(OP).find(t=>OP[t]===e)||"UNKNOWN",i=a.toString(16).padStart(4,"0")+": "+s;[OP.LOAD_IMM,OP.STORE,OP.LOAD,OP.LOAD8,OP.STORE8,OP.LOAD16,OP.STORE16,OP.JMP,OP.JZ,OP.JNZ,OP.LOAD_LOCAL,OP.STORE_LOCAL,OP.CALL,OP.LOAD_STR].includes(e)?(t=r[a+1]|r[a+2]<<8|r[a+3]<<16|r[a+4]<<24,e===OP.LOAD_STR&&t<n.length?i+=` ${t} "${n[t]}"`:i+=" "+t,a+=5):a++,h.push(i)}return h.join("\n")}static decode(t){return(new CCCompiler).disassemble(t)}static isValidBytecode(t){return!(t.length<6)&&(t[0]|t[1]<<8|t[2]<<16|t[3]<<24)===CC_MAGIC}}class CCVM{constructor(t,e){this.memory=t,this.cycleEngine=e,this.registers=new Uint32Array(16),this.stack=new Uint32Array(256),this.callStack=[],this.locals=new Uint32Array(256),this.sp=0,this.pc=0,this.running=!1,this.bytecode=null,this.onPrint=null,this.instructionsExecuted=0,this.lastPerfUpdate=performance.now(),this.ipsMetric=0,this.stringTable=[],this.exports=new Map}load(r){if(this.bytecode=r,this.stringTable=[],this.exports=new Map,CCCompiler.isValidBytecode(r)){let i=6,e=r[i++];for(let t=0;t<e;t++){let e=r[i++],s="";for(let t=0;t<e;t++)s+=String.fromCharCode(r[i++]);this.stringTable.push(s)}if(i<r.length){var s=r[i++];for(let t=0;t<s&&i+7<r.length;t++){var h=r[i]|r[i+1]<<8|r[i+2]<<16|r[i+3]<<24,a=r[i+=4]|r[i+1]<<8|r[i+2]<<16|r[i+3]<<24,h=(i+=4,0<=h&&h<this.stringTable.length?this.stringTable[h]:"#"+h);this.exports.set(h,a)}}this.pc=i}else this.pc=0;this.sp=0,this.registers.fill(0),this.locals.fill(0),this.callStack=[]}call(t,...e){var s=this.exports.get(t);if(void 0===s)throw new Error(`Function '${t}' not found in module exports.`);var t=this.pc,i=this.running;for(let t=e.length-1;0<=t;t--)this.registers[0]=e[t],this._push();this.pc=s,this.running=!0;for(var r=this.callStack.length;this.running&&this.step()&&!(this.callStack.length<r););s=this.registers[0];return this.pc=t,this.running=i,s}async fetchAndLoad(t){var e,s=await fetch(t);if(!s.ok)throw new Error("Failed to fetch "+t);t.endsWith(".cc")?(t=await s.text(),e=new CCCompiler,this.load(e.compile(t))):(e=await s.arrayBuffer(),this.load(new Uint8Array(e)))}step(){if(!this.bytecode||this.pc>=this.bytecode.length)return this.running=!1;var t=this.bytecode[this.pc++],e=(this.instructionsExecuted++,(this._handlers||(this._handlers=this._buildHandlers()))[t]);if(!e)throw new Error("Unknown opcode: 0x"+t.toString(16));e.call(this);t=performance.now();return 1e3<=t-this.lastPerfUpdate&&(this.ipsMetric=this.instructionsExecuted,this.instructionsExecuted=0,this.lastPerfUpdate=t),!0}_buildHandlers(){var t={};return t[OP.LOAD_IMM_0]=function(){this.registers[0]=0},t[OP.LOAD_IMM_1]=function(){this.registers[0]=1},t[OP.LOAD_IMM_M1]=function(){this.registers[0]=-1},t[OP.INC_LOCAL]=function(){var t=this._readOperand();this.locals[t]=this.locals[t]+1>>>0,this.registers[0]=this.locals[t]},t[OP.DEC_LOCAL]=function(){var t=this._readOperand();this.locals[t]=this.locals[t]-1>>>0,this.registers[0]=this.locals[t]},t[OP.ADD_IMM]=function(){this.registers[0]=this.registers[0]+this._readOperand()>>>0},t[OP.SUB_IMM]=function(){this.registers[0]=this.registers[0]-this._readOperand()>>>0},t[OP.MUL_IMM]=function(){this.registers[0]=Math.imul(this.registers[0],this._readOperand())>>>0},t[OP.CMP_ZERO]=function(){this.registers[0]=0===this.registers[0]?1:0},t[OP.STORE_PUSH]=function(){var t=this._readOperand();this.locals[t]=this.registers[0],this.stack[this.sp++]=this.registers[0]},t[OP.LOAD_IMM]=function(){this.registers[0]=this._readOperand()},t[OP.LOAD]=function(){this.registers[0]=this.memory.read(this._readOperand())},t[OP.STORE]=function(){this.memory.write(this._readOperand(),this.registers[0])},t[OP.LOAD8]=function(){this.registers[0]=255&this.memory.read(this._readOperand())},t[OP.STORE8]=function(){this.memory.write(this._readOperand(),255&this.registers[0])},t[OP.LOAD16]=function(){this.registers[0]=65535&this.memory.read16(this._readOperand())},t[OP.STORE16]=function(){this.memory.write16(this._readOperand(),65535&this.registers[0])},t[OP.LOAD_LOCAL]=function(){this.registers[0]=this.locals[this._readOperand()]||0},t[OP.STORE_LOCAL]=function(){this.locals[this._readOperand()]=this.registers[0]},t[OP.LOAD_STR]=function(){var t=this._readOperand();this.registers[0]={type:"string",value:this.stringTable[t]||""}},t[OP.ADD]=function(){this.registers[0]=this.stack[--this.sp]+this.registers[0]>>>0},t[OP.SUB]=function(){this.registers[0]=this.stack[--this.sp]-this.registers[0]>>>0},t[OP.MUL]=function(){this.registers[0]=Math.imul(this.stack[--this.sp],this.registers[0])>>>0},t[OP.DIV]=function(){var t=this.registers[0];this.registers[0]=0!==t?Math.floor(this.stack[--this.sp]/t):0},t[OP.MOD]=function(){var t=this.registers[0];this.registers[0]=0!==t?this.stack[--this.sp]%t:0},t[OP.INC]=function(){this.registers[0]=this.registers[0]+1>>>0},t[OP.DEC]=function(){this.registers[0]=this.registers[0]-1>>>0},t[OP.NEG]=function(){this.registers[0]=-this.registers[0]>>>0},t[OP.EQ]=function(){this.registers[0]=this.stack[--this.sp]===this.registers[0]?1:0},t[OP.NE]=function(){this.registers[0]=this.stack[--this.sp]!==this.registers[0]?1:0},t[OP.LT]=function(){this.registers[0]=this.stack[--this.sp]<this.registers[0]?1:0},t[OP.GT]=function(){this.registers[0]=this.stack[--this.sp]>this.registers[0]?1:0},t[OP.LE]=function(){this.registers[0]=this.stack[--this.sp]<=this.registers[0]?1:0},t[OP.GE]=function(){this.registers[0]=this.stack[--this.sp]>=this.registers[0]?1:0},t[OP.AND]=function(){this.registers[0]=this.stack[--this.sp]&this.registers[0]},t[OP.OR]=function(){this.registers[0]=this.stack[--this.sp]|this.registers[0]},t[OP.XOR]=function(){this.registers[0]=this.stack[--this.sp]^this.registers[0]},t[OP.SHL]=function(){this.registers[0]=this.stack[--this.sp]<<this.registers[0]},t[OP.SHR]=function(){this.registers[0]=this.stack[--this.sp]>>this.registers[0]},t[OP.NOT]=function(){this.registers[0]=~this.registers[0]},t[OP.PUSH]=function(){this.stack[this.sp++]=this.registers[0]},t[OP.POP]=function(){this.registers[0]=this.stack[--this.sp]},t[OP.DUP]=function(){this.stack[this.sp]=this.stack[this.sp-1],this.sp++},t[OP.SWAP]=function(){[this.stack[this.sp-1],this.stack[this.sp-2]]=[this.stack[this.sp-2],this.stack[this.sp-1]]},t[OP.JMP]=function(){this.pc=this._readOperand()},t[OP.JZ]=function(){var t=this._readOperand();0===this.registers[0]&&(this.pc=t)},t[OP.JNZ]=function(){var t=this._readOperand();0!==this.registers[0]&&(this.pc=t)},t[OP.CALL]=function(){var t=this._readOperand();this.callStack.push(this.pc),this.pc=t},t[OP.RET]=function(){0<this.callStack.length?this.pc=this.callStack.pop():this.running=!1},t[OP.LOOP]=function(){},t[OP.ENDLOOP]=function(){},t[OP.BREAK]=function(){},t[OP.CONTINUE]=function(){},t[OP.TICK]=function(){this.cycleEngine&&this.cycleEngine.tick(()=>{})},t[OP.WAIT]=function(){var t;this.cycleEngine&&(t="object"==typeof this.registers[0]?0:this.registers[0],this.cycleEngine.run(t,()=>{}))},t[OP.PRINT]=function(){var t;this.onPrint&&("object"==typeof(t=this.registers[0])&&"string"===t.type?this.onPrint(t.value):this.onPrint(t))},t[OP.NOP]=function(){},t[OP.HALT]=function(){this.running=!1},t}_stepLegacy(){var t=this.bytecode[this.pc++];switch(this.instructionsExecuted++,t){case OP.LOAD_IMM_0:this.registers[0]=0;break;case OP.LOAD_IMM_1:this.registers[0]=1;break;case OP.LOAD_IMM_M1:this.registers[0]=-1;break;case OP.INC_LOCAL:var e=this._readOperand();this.locals[e]=this.locals[e]+1>>>0,this.registers[0]=this.locals[e];break;case OP.DEC_LOCAL:var e=this._readOperand();this.locals[e]=this.locals[e]-1>>>0,this.registers[0]=this.locals[e];break;case OP.ADD_IMM:var e=this._readOperand();this.registers[0]=this.registers[0]+e>>>0;break;case OP.SUB_IMM:e=this._readOperand();this.registers[0]=this.registers[0]-e>>>0;break;case OP.MUL_IMM:e=this._readOperand();this.registers[0]=Math.imul(this.registers[0],e)>>>0;break;case OP.CMP_ZERO:this.registers[0]=0===this.registers[0]?1:0;break;case OP.STORE_PUSH:e=this._readOperand();this.locals[e]=this.registers[0],this.stack[this.sp++]=this.registers[0];break;case OP.LOAD_IMM:this.registers[0]=this._readOperand();break;case OP.LOAD:this.registers[0]=this.memory.read(this._readOperand());break;case OP.STORE:this.memory.write(this._readOperand(),this.registers[0]);break;case OP.LOAD8:this.registers[0]=255&this.memory.read(this._readOperand());break;case OP.STORE8:this.memory.write(this._readOperand(),255&this.registers[0]);break;case OP.LOAD16:this.registers[0]=65535&this.memory.read16(this._readOperand());break;case OP.STORE16:this.memory.write16(this._readOperand(),65535&this.registers[0]);break;case OP.LOAD_LOCAL:this.registers[0]=this.locals[this._readOperand()]||0;break;case OP.STORE_LOCAL:this.locals[this._readOperand()]=this.registers[0];break;case OP.LOAD_STR:e=this._readOperand();this.registers[0]={type:"string",value:this.stringTable[e]||""};break;case OP.ADD:this._binaryOp((t,e)=>t+e>>>0);break;case OP.SUB:this._binaryOp((t,e)=>t-e>>>0);break;case OP.MUL:this._binaryOp((t,e)=>Math.imul(t,e)>>>0);break;case OP.DIV:this._binaryOp((t,e)=>0!==e?t/e|0:0);break;case OP.MOD:this._binaryOp((t,e)=>0!==e?t%e:0);break;case OP.INC:this.registers[0]=this.registers[0]+1>>>0;break;case OP.DEC:this.registers[0]=this.registers[0]-1>>>0;break;case OP.NEG:this.registers[0]=-this.registers[0]>>>0;break;case OP.EQ:this._binaryOp((t,e)=>t===e?1:0);break;case OP.NE:this._binaryOp((t,e)=>t!==e?1:0);break;case OP.LT:this._binaryOp((t,e)=>t<e?1:0);break;case OP.GT:this._binaryOp((t,e)=>e<t?1:0);break;case OP.LE:this._binaryOp((t,e)=>t<=e?1:0);break;case OP.GE:this._binaryOp((t,e)=>e<=t?1:0);break;case OP.AND:this._binaryOp((t,e)=>t&e);break;case OP.OR:this._binaryOp((t,e)=>t|e);break;case OP.XOR:this._binaryOp((t,e)=>t^e);break;case OP.SHL:this._binaryOp((t,e)=>t<<e);break;case OP.SHR:this._binaryOp((t,e)=>t>>e);break;case OP.NOT:this.registers[0]=~this.registers[0];break;case OP.PUSH:this._push();break;case OP.POP:this.registers[0]=this.stack[--this.sp];break;case OP.DUP:this.stack[this.sp]=this.stack[this.sp-1],this.sp++;break;case OP.SWAP:[this.stack[this.sp-1],this.stack[this.sp-2]]=[this.stack[this.sp-2],this.stack[this.sp-1]];break;case OP.JMP:this.pc=this._readOperand();break;case OP.JZ:e=this._readOperand();0===this.registers[0]&&(this.pc=e);break;case OP.JNZ:e=this._readOperand();0!==this.registers[0]&&(this.pc=e);break;case OP.CALL:e=this._readOperand();this.callStack.push(this.pc),this.pc=e;break;case OP.RET:if(!(0<this.callStack.length))return this.running=!1;this.pc=this.callStack.pop();break;case OP.LOOP:case OP.ENDLOOP:case OP.BREAK:case OP.CONTINUE:break;case OP.TICK:this.cycleEngine&&this.cycleEngine.tick(()=>{});break;case OP.WAIT:this.cycleEngine&&(e="object"==typeof this.registers[0]?0:this.registers[0],this.cycleEngine.run(e,()=>{}));break;case OP.PRINT:this.onPrint&&("object"==typeof(e=this.registers[0])&&"string"===e.type?this.onPrint(e.value):this.onPrint(e));break;case OP.NOP:break;case OP.HALT:return this.running=!1;default:throw new Error("Unknown opcode: 0x"+t.toString(16))}var s=performance.now();return 1e3<=s-this.lastPerfUpdate&&(this.ipsMetric=this.instructionsExecuted,this.instructionsExecuted=0,this.lastPerfUpdate=s),!0}_push(){this.stack[this.sp++]=this.registers[0]}_binaryOp(t){this.registers[0]=t(this.stack[--this.sp],this.registers[0])>>>0}_readOperand(){var t=this.pc;return this.pc+=4,this.bytecode[t]|this.bytecode[t+1]<<8|this.bytecode[t+2]<<16|this.bytecode[t+3]<<24}run(t=1e4){this.running=!0;let e=0;for(;this.running&&e<t&&this.step();)e++;return e}getPerformance(){return{instructionsPerSecond:this.ipsMetric,programCounter:this.pc,stackPointer:this.sp}}reset(){this.pc=0,this.sp=0,this.registers.fill(0),this.locals.fill(0),this.callStack=[],this.running=!1,this.instructionsExecuted=0}}class GenericCPU{constructor(t,e){this.memory=t,this.cycleEngine=e,this.registers={pc:0,sp:255,a:0,x:0,y:0,status:0},this.opcodes=new Array(256).fill(null),this.interrupts={irq:!1,nmi:!1},this.vectors={nmi:65530,reset:65532,irq:65534}}addOpcode(t,e,s,i,r){this.opcodes[t]={name:e,size:s,cycles:i,fn:r}}reset(){this.registers.pc=this.memory.read16(this.vectors.reset),this.registers.sp=255,this.registers.status=36}step(){if(this.interrupts.nmi)this._handleInterrupt(this.vectors.nmi),this.interrupts.nmi=!1;else if(!this.interrupts.irq||4&this.registers.status){var t=this.memory.read(this.registers.pc),e=this.opcodes[t];if(!e)throw new Error(`Unknown Opcode: 0x${t.toString(16)} at 0x`+this.registers.pc.toString(16));this.registers.pc=this.registers.pc+e.size&65535,this.cycleEngine.run(e.cycles,()=>{}),e.fn(this)}else this._handleInterrupt(this.vectors.irq)}_handleInterrupt(t){this._push16(this.registers.pc),this._push(this.registers.status),this.registers.status|=4,this.registers.pc=this.memory.read16(t),this.cycleEngine.run(7,()=>{})}_push(t){this.memory.write(256+this.registers.sp,t),this.registers.sp=this.registers.sp-1&255}_push16(t){this._push(t>>8),this._push(255&t)}_pop(){return this.registers.sp=this.registers.sp+1&255,this.memory.read(256+this.registers.sp)}_pop16(){var t=this._pop();return this._pop()<<8|t}}class Mapper{constructor(t){this.memory=t,this.banks=new Map}defineBank(t,e){this.banks.set(t,e)}mountBank(t,e){t=this.banks.get(t);t&&this.memory.load(e,t)}}class ScanlinePPU{constructor(t,e={}){this.engine=t,this.scanlines=e.scanlines||262,this.cyclesPerLine=e.cyclesPerLine||341,this.vblankLine=e.vblankLine||240,this.currentLine=0,this.onScanline=null,this.onVBlank=null,this.running=!1}start(){this.running||(this.running=!0,this._scheduleNext())}stop(){this.running=!1}_scheduleNext(){this.running&&this.engine.after(this.cyclesPerLine,()=>{this.currentLine=(this.currentLine+1)%this.scanlines,this.onScanline&&this.onScanline(this.currentLine),this.currentLine===this.vblankLine&&this.onVBlank&&this.onVBlank(),this._scheduleNext()})}}class SimpleInput{constructor(){this.state=0,this.mapping={},"undefined"!=typeof window&&(window.addEventListener("keydown",t=>{this.mapping[t.code]&&(this.state|=this.mapping[t.code])}),window.addEventListener("keyup",t=>{this.mapping[t.code]&&(this.state&=~this.mapping[t.code])}))}map(t,e){this.mapping[t]=e}read(){return this.state}}let CC_FILE_EXT=".cc",CCASM_FILE_EXT=".ccasm",CC_HEADER_SIZE=6;"undefined"!=typeof window&&(window.CycleCore={Signal:Signal,effect:effect,CycleEngine:CycleEngine,State:State,Bits:Bits,match:match,range:range,oneOf:oneOf,bits:bits,Entity:Entity,World:World,Schema:Schema,Memory:Memory,CCCompiler:CCCompiler,CCVM:CCVM,GenericCPU:GenericCPU,Mapper:Mapper,ScanlinePPU:ScanlinePPU,SimpleInput:SimpleInput,OP:OP,CC_MAGIC:CC_MAGIC,CC_VERSION:CC_VERSION,CC_FILE_EXT:CC_FILE_EXT,CCASM_FILE_EXT:CCASM_FILE_EXT,CC_HEADER_SIZE:CC_HEADER_SIZE});export{Signal,effect,CycleEngine,State,Bits,match,range,oneOf,bits,Entity,World,Schema,Memory,CCCompiler,CCVM,GenericCPU,Mapper,ScanlinePPU,SimpleInput,OP,CC_MAGIC,CC_VERSION,CC_FILE_EXT,CCASM_FILE_EXT,CC_HEADER_SIZE};
